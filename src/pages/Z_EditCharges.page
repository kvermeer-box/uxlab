<apex:page standardController="zqu__Quote__c"
            extensions="Z_EditCharges,Z_ProductSelector"
            sidebar="false"
            title="Amendment"
            action="{!onLoad}">

    <!-- Add the jQuery library -->
    <apex:includeScript value="{!$Resource.zqu__JQuery142}" />

    <!-- Disable all input field right after editing one -->
    <script>
    var j$ = jQuery.noConflict();

    // Disable all text input (when editing a charge)
    function disableAllInput() {
        j$("input[type=text]").attr('disabled', 'disabled');
    }

    // Re-enable all intpus
    function enableAllInput() {
        j$("input[type=text]").removeAttr('disabled');
    }
    </script>
   
    <apex:pageMessages id="msg_top" />
 
    <apex:sectionHeader title="Quote" subtitle="Edit Quote" />

    <apex:form id="mainForm" rendered="{!initSuccess}">

        <apex:pageBlock title="Edit Quote">

            <apex:pageBlockSection title="Subscription" columns="1" id="panSubscriptionProducts">

                <apex:repeat value="{!editChargeGroupRowList}" var="editChargeGroupRow">

                    <apex:outputPanel layout="block" style="border: 1px solid black; padding: .5em;">

                        <!-- TYPE_AMENDMENT_ORIGINAL -->
                        <apex:outputPanel rendered="{!editChargeGroupRow.chargeGroup.groupType == 3}"
                                            layout="block"
                                            style="background-color:#666600;color:white;font-weight:bold;padding: .3em;">

                            {!editChargeGroupRow.chargeGroup.productName} : {!editChargeGroupRow.chargeGroup.ratePlanName}

                        </apex:outputPanel>

                        <!-- TYPE_AMENDMENT_NEWPRODUCT -->
                        <apex:outputPanel rendered="{!editChargeGroupRow.chargeGroup.groupType == 4}"
                                            layout="block"
                                            style="background-color:#66CC33;color:white;font-weight:bold;;padding: .3em;">

                            {!editChargeGroupRow.chargeGroup.productName} : {!editChargeGroupRow.chargeGroup.ratePlanName}

                        </apex:outputPanel>

                        <!-- TYPE_AMENDMENT_UPDATEDPRODUCT -->
                        <apex:outputPanel rendered="{!editChargeGroupRow.chargeGroup.groupType == 5}"
                                            layout="block"
                                            style="background-color:#CCCC66;color:white;font-weight:bold;padding: .3em;">

                            {!editChargeGroupRow.chargeGroup.productName} : {!editChargeGroupRow.chargeGroup.ratePlanName}

                        </apex:outputPanel>


                        <!-- TYPE_AMENDMENT_REMOVEPRODUCT -->
                        <apex:outputPanel rendered="{!editChargeGroupRow.chargeGroup.groupType == 6}"
                                            layout="block"
                                            style="background-color:#666666;color:white;font-weight:bold;padding: .3em;text-decoration:line-through;">

                            {!editChargeGroupRow.chargeGroup.productName} : {!editChargeGroupRow.chargeGroup.ratePlanName}

                        </apex:outputPanel>

                        <!-- TYPE_REWENAL_RENEWED -->
                        <apex:outputPanel rendered="{!editChargeGroupRow.chargeGroup.groupType == 7}"
                                            layout="block"
                                            style="background-color:#666600;color:white;font-weight:bold;padding: .3em;">

                            {!editChargeGroupRow.chargeGroup.productName} : {!editChargeGroupRow.chargeGroup.ratePlanName}

                        </apex:outputPanel>

                        <!-- TYPE_RENEWAL_NEWPRODUCT -->
                        <apex:outputPanel rendered="{!editChargeGroupRow.chargeGroup.groupType == 8}"
                                            layout="block"
                                            style="background-color:#66CC33;color:white;font-weight:bold;;padding: .3em;">

                            {!editChargeGroupRow.chargeGroup.productName} : {!editChargeGroupRow.chargeGroup.ratePlanName}

                        </apex:outputPanel>

                        <!-- TYPE_RENEWAL_UPDATE_PRODUCT -->
                        <apex:outputPanel rendered="{!editChargeGroupRow.chargeGroup.groupType == 9}"
                                            layout="block"
                                            style="background-color:#CCCC66;color:white;font-weight:bold;padding: .3em;">

                            {!editChargeGroupRow.chargeGroup.productName} : {!editChargeGroupRow.chargeGroup.ratePlanName}

                        </apex:outputPanel>

                        <!-- TYPE_RENEWAL_REMOVEPRODUCT -->
                        <apex:outputPanel rendered="{!editChargeGroupRow.chargeGroup.groupType == 10}"
                                            layout="block"
                                            style="background-color:#666666;color:white;font-weight:bold;padding: .3em;text-decoration:line-through;">

                            {!editChargeGroupRow.chargeGroup.productName} : {!editChargeGroupRow.chargeGroup.ratePlanName}

                        </apex:outputPanel>

                        <!-- Display the charges under the rate plans -->
                        <apex:pageBlockTable value="{!editChargeGroupRow.editChargeRows}" var="editChargeRow" style="margin-top:1em; margin-bottom: 1em;">

                            <apex:column value="{!editChargeRow.charge.NAME}" headerValue="Charge Name" width="20%" />

                            <apex:column value="{!editChargeRow.charge.CHARGE_TYPE}" headerValue="Type" width="12%" />

                            <apex:column value="{!editChargeRow.charge.MODEL}" headerValue="Model" width="12%" />

                            <apex:column value="{!editChargeRow.charge.LIST_PRICE}" headerValue="List Price" width="7%" rendered="{!!editChargeGroupRow.isPercentProduct}"/>

                            <!--  Custom List Price -->
                            <apex:column value="{!editChargeRow.listPrice}" headerValue="List Price" width="7%" rendered="{!editChargeGroupRow.isPercentProduct}"/>

                            <apex:column headerValue="Discount" width="7%" rendered="{!!editChargeGroupRow.isPercentProduct}">

                                <!-- KV EDIT: INPUT ONLY DISPLAYED IF ITS NOT A LICENSE AMENDMENT -->
                                <apex:outputText value="{!editChargeRow.charge.DISCOUNT}"
                                                    rendered="{!AND(!editChargeGroupRow.isPercentProduct, OR(groupEditMap[editChargeGroupRow.chargeGroup.groupId] != 'FULL', NOT(editChargeRow.charge.isDiscountEditable), editChargeGroupRow.isUpsellRow))}" />

                                <apex:inputText style="width:65%;font-weight:bold;"
                                                value="{!editChargeRow.charge.DISCOUNT}"
                                                rendered="{!AND(!editChargeGroupRow.isPercentProduct, groupEditMap[editChargeGroupRow.chargeGroup.groupId] == 'FULL', editChargeRow.charge.isDiscountEditable, NOT(AND(editChargeGroupRow.isLicenseProduct,editChargeGroupRow.isUpsellRow)))}">

                                    <apex:actionSupport event="onchange"
                                                        action="{!onDiscountChange}"
                                                        status="stsEditGroup"
                                                        reRender="panSubscriptionProducts" />

                                </apex:inputText>

                                <apex:outputText value=" %" rendered="{!AND(!editChargeGroupRow.isPercentProduct, ISNUMBER(editChargeRow.charge.DISCOUNT))}" />

                            </apex:column>

                            <!--  Custom Discount -->
                            <apex:column headerValue="Discount" width="7%" rendered="{!editChargeGroupRow.isPercentProduct}">

                                <apex:outputText value="{!editChargeRow.discount}"
                                                    rendered="{!AND(editChargeGroupRow.isPercentProduct, OR(groupEditMap[editChargeGroupRow.chargeGroup.groupId] != 'DISCOUNT', !editChargeRow.charge.isDiscountEditable))}" />

                                <apex:inputText style="width:65%;font-weight:bold;"
                                                value="{!editChargeRow.discount}"
                                                rendered="{!AND(editChargeGroupRow.isPercentProduct, groupEditMap[editChargeGroupRow.chargeGroup.groupId] == 'DISCOUNT', editChargeRow.charge.isDiscountEditable)}">

                                    <apex:actionSupport event="onchange"
                                                        action="{!customDiscountEdit}"
                                                        status="stsEditGroup"
                                                        reRender="panSubscriptionProducts" />

                                </apex:inputText>

                                <apex:outputText value=" %" rendered="{!editChargeGroupRow.isPercentProduct}" />

                            </apex:column>

                            <!-- License upsell product fields -->
                            <!-- Only displayed if: Is a license products AND is an Amendment of an old product -->
                            <apex:column headerValue="Upsell Price" rendered="{!AND(editChargeGroupRow.isLicenseProduct,editChargeGroupRow.isUpsellRow)}">
                                <apex:outputText value="{!ROUND(editChargeRow.upsellPrice, 2)}" rendered="{!groupEditMap[editChargeGroupRow.chargeGroup.groupId] != 'FULL'}"/>
                                <apex:inputText value="{!editChargeRow.upsellPrice}" rendered="{!groupEditMap[editChargeGroupRow.chargeGroup.groupId] == 'FULL'}">
                                    <apex:actionSupport event="onchange"
                                                        action="{!onUpsellPriceChange}"
                                                        status="stsEditGroup"
                                                        reRender="panSubscriptionProducts" />
                                </apex:inputText>
                                <!-- will need to add support action -->

                            </apex:column>

                            <!-- Only displayed if: Is a license products AND is an Amendment of an old product -->
                            <apex:column headerValue="Upsell Quantity" rendered="{!AND(editChargeGroupRow.isLicenseProduct,editChargeGroupRow.isUpsellRow)}">
                                <apex:outputText value="{!ROUND(editChargeRow.upsellQuantity,0)}" rendered="{!groupEditMap[editChargeGroupRow.chargeGroup.groupId] != 'FULL'}"/>
                                <apex:inputText value="{!editChargeRow.upsellQuantity}" rendered="{!groupEditMap[editChargeGroupRow.chargeGroup.groupId] == 'FULL'}">
                                    <apex:actionSupport event="onchange"
                                                        action="{!onUpsellQuantityChange}"
                                                        status="stsEditGroup"
                                                        reRender="panSubscriptionProducts" />
                                </apex:inputText>
                                <!-- will need to add support action -->
                            </apex:column>
                            <!-- /License upsell product fields -->



                            <apex:column headerValue="Effective Price" width="7%">

                                <!-- KV EDIT: INPUT ONLY DISPLAYED IF ITS NOT A LICENSE AMENDMENT -->
                                <apex:outputText value="{!editChargeRow.charge.EFFECTIVE_PRICE}"
                                                    rendered="{!OR(groupEditMap[editChargeGroupRow.chargeGroup.groupId] != 'FULL', NOT(editChargeRow.charge.isEffectivePriceEditable), AND(editChargeGroupRow.isLicenseProduct,editChargeGroupRow.isUpsellRow))}" />

                                <apex:inputText style="width:85%;font-weight:bold;"
                                                value="{!editChargeRow.charge.EFFECTIVE_PRICE}"
                                                rendered="{!AND(groupEditMap[editChargeGroupRow.chargeGroup.groupId] == 'FULL', editChargeRow.charge.isEffectivePriceEditable,NOT(AND(editChargeGroupRow.isLicenseProduct,editChargeGroupRow.isUpsellRow)))}">

                                    <apex:actionSupport event="onchange"
                                                        action="{!onEffectivePriceChange}"
                                                        status="stsEditGroup"
                                                        reRender="panSubscriptionProducts" />

                                </apex:inputText>

                            </apex:column>

                            <apex:column headerValue="Quantity" width="7%">

                                <!-- KV EDIT: INPUT ONLY DISPLAYED IF ITS NOT A LICENSE AMENDMENT -->
                                <apex:outputText value="{!editChargeRow.charge.QUANTITY}"
                                                rendered="{!OR(groupEditMap[editChargeGroupRow.chargeGroup.groupId] == 'NO_EDIT', NOT(editChargeRow.charge.isQuantityEditable), AND(editChargeGroupRow.isLicenseProduct,editChargeGroupRow.isUpsellRow))}" />

                                <apex:inputText style="width:85%;font-weight:bold"
                                                value="{!editChargeRow.charge.QUANTITY}"
                                                rendered="{!AND(groupEditMap[editChargeGroupRow.chargeGroup.groupId] != 'NO_EDIT', editChargeRow.charge.isQuantityEditable, NOT(AND(editChargeGroupRow.isLicenseProduct,editChargeGroupRow.isUpsellRow)))}">

                                    <apex:actionSupport event="onchange"
                                                        action="{!onQuantityChange}"
                                                        status="stsEditGroup"
                                                        reRender="panSubscriptionProducts" />

                                </apex:inputText>

                            </apex:column>

                            <apex:column value="{!editChargeRow.charge.PERIOD}" headerValue="Period" width="7%" />

                            <apex:column headerValue="List Total" width="7%">

                                <!-- KV EDIT: INPUT ONLY DISPLAYED IF ITS NOT A LICENSE AMENDMENT -->
                                <apex:outputText value="{!editChargeRow.charge.TOTAL}"
                                                    rendered="{!OR(groupEditMap[editChargeGroupRow.chargeGroup.groupId] != 'FULL', NOT(editChargeRow.charge.isTotalEditable), AND(editChargeGroupRow.isLicenseProduct,editChargeGroupRow.isUpsellRow))}" />

                                <apex:inputText style="width:85%;font-weight:bold;"
                                                value="{!editChargeRow.charge.TOTAL}"
                                                rendered="{!AND(groupEditMap[editChargeGroupRow.chargeGroup.groupId] == 'FULL', editChargeRow.charge.isTotalEditable, NOT(AND(editChargeGroupRow.isLicenseProduct,editChargeGroupRow.isUpsellRow)))}">

                                    <apex:actionSupport event="onchange"
                                                        action="{!onTotalChange}"
                                                        status="stsEditGroup"
                                                        reRender="panSubscriptionProducts, panChangesVsOriginal" />

                                </apex:inputText>

                            </apex:column>

                            <apex:column value="{!editChargeRow.charge.TOTAL}" headerValue="Total" width="7%" />

                        </apex:pageBlockTable>

                        <!-- Different button according to the group charge type -->
                        <apex:outputPanel layout="block">

                            <apex:actionStatus id="stsEditGroup">

                                <apex:facet name="stop">

                                    <apex:outputPanel >

                                        <apex:commandButton value="Save"
                                                            action="{!saveGroup}"
                                                            status="stsEditGroup"
                                                            reRender="mainForm, msg, hiddenBlock"
                                                            rendered="{!groupEditMap[editChargeGroupRow.chargeGroup.groupId] != 'NO_EDIT'}" />

                                        <apex:commandButton value="Edit"
                                                            action="{!editGroup}"
                                                            status="stsEditGroup"
                                                            reRender="mainForm, msg, hiddenBlock"
                                                            rendered="{!AND(editChargeGroupRow.chargeGroup.showVisualForceEdit, groupEditMap[editChargeGroupRow.chargeGroup.groupId] == 'NO_EDIT')}">

                                            <apex:param name="groupId"
                                                        value="{!editChargeGroupRow.chargeGroup.groupId}"
                                                        assignTo="{!selectedChargeGroup}" />

                                        </apex:commandButton>

                                        <apex:commandButton value="Cancel"
                                                            action="{!cancelEditGroup}"
                                                            status="stsEditGroup"
                                                            rendered="{!groupEditMap[editChargeGroupRow.chargeGroup.groupId] != 'NO_EDIT'}" />


                                        <apex:commandButton action="{!deleteGroup}"
                                                            value="Delete"
                                                            status="stsEditGroup"
                                                            reRender="mainForm, msg, hiddenBlock"
                                                            rendered="{!AND(editChargeGroupRow.chargeGroup.showVisualForceDelete, groupEditMap[editChargeGroupRow.chargeGroup.groupId] == 'NO_EDIT', subscriptionMap[editChargeGroupRow.chargeGroup.groupId])}">

                                            <apex:param name="groupId"
                                                        value="{!editChargeGroupRow.chargeGroup.groupId}"
                                                        assignTo="{!selectedChargeGroup}" />

                                        </apex:commandButton>
<!--
                                        <apex:commandButton action="{!unDeleteGroup}"
                                                            value="Undelete"
                                                            status="stsEditGroup"
                                                            reRender="mainForm, msg, hiddenBlock"
                                                            rendered="{!editChargeGroupRow.chargeGroup.showVisualForceUndelete}">

                                            <apex:param name="groupId"
                                                        value="{!editChargeGroupRow.chargeGroup.groupId}"
                                                        assignTo="{!selectedChargeGroup}" />

                                        </apex:commandButton>
-->
                                    </apex:outputPanel>

                                </apex:facet>

                                <apex:facet name="start">

                                    <apex:commandButton value="Processing..." disabled="true" status="stsEditGroup" />

                                </apex:facet>

                            </apex:actionStatus>

                        </apex:outputPanel>

                    </apex:outputPanel>

                </apex:repeat>

                <apex:pageBlockSectionItem >

                    <apex:actionStatus id="stsDisplayCatalog">

                        <apex:facet name="start">

                            <apex:outputPanel >

                                <apex:commandButton value="Querying Product Catalog..."
                                                    disabled="true"
                                                    status="stsDisplayCatalog"
                                                    rendered="{!!displayProductCatalog}" />

                                <apex:commandButton value="Removing Product Catalog..."
                                                    disabled="true"
                                                    status="stsDisplayCatalog"
                                                    rendered="{!displayProductCatalog}" />

                            </apex:outputPanel>

                        </apex:facet>

                        <apex:facet name="stop">

                            <apex:outputPanel >

                                <!--
                                <apex:commandButton action="{!productSelector}"
                                                    value="Add Products" />
                                -->

                                <!-- To restore Add More Products replace false with "{!!displayProductCatalog}" -->
                                <apex:commandButton action="{!doDisplayProductCatalog}"
                                                    value="Add Products"
                                                    status="stsDisplayCatalog"
                                                    rendered="{!!displayProductCatalog}"
                                                    reRender="mainForm" />

                                <apex:commandButton action="{!cancelDisplayProductCatalog}"
                                                    value="Cancel Adding Product"
                                                    status="stsDisplayCatalog"
                                                    rendered="{!displayProductCatalog}"
                                                    reRender="mainForm" />

                            </apex:outputPanel>

                        </apex:facet>

                    </apex:actionStatus>

                </apex:pageBlockSectionItem>

            </apex:pageBlockSection>

            <!-- BEGIN insert product catalog -->
            <apex:outputPanel id="panProductSelector" rendered="{!displayProductCatalog}">

                <apex:pageBlock title="Product">
<!--
                    <apex:pageBlockButtons style="text-align:right" location="top">

                        <apex:actionRegion >

                            <apex:inputText id="itProductSearch" value="{!productSearchString}" />

                        </apex:actionRegion>

                        <apex:actionStatus id="stsProductSearch">

                            <apex:facet name="start">

                                <apex:commandButton value="Searching..."
                                                    disabled="true"
                                                    status="stsProductSearch" />

                            </apex:facet>

                            <apex:facet name="stop">

                                <apex:commandButton id="btnSearchProducts"
                                                    value="Search"
                                                    status="stsProductSearch"
                                                    action="{!refreshProducts}"
                                                    rerender="panProductSelector, panRatePlanSelector, panChargeGroup" />

                            </apex:facet>

                        </apex:actionStatus>

                    </apex:pageBlockButtons>
-->
<!-- keep in case we need filtering based on field
                    <apex:pageBlockSection rendered="{!productWrapperOptionsList.size > 0}">

                        <apex:repeat value="{!productWrapperOptionsList}" var="wrapOptions">

                            <apex:pageBlockSectionItem >

                                <apex:outputLabel value="{!wrapOptions.fieldLabel}" />

                                <apex:actionRegion >

                                    <apex:selectList value="{!wrapOptions.value}" size="1">

                                        <apex:actionSupport event="onchange"
                                                            rerender="msg, panProductSelector, panRatePlanSelector, panChargeGroup"
                                                            action="{!refreshProducts}" />

                                        <apex:selectOptions value="{!wrapOptions.items}" />

                                    </apex:selectList>

                                </apex:actionRegion>

                            </apex:pageBlockSectionItem>

                        </apex:repeat>

                    </apex:pageBlockSection>
-->

                    <apex:pageBlockTable value="{!productList}" var="product" id="tblProduct" title="products"
                                            columns="4" cellpadding="3%" cellspacing="3%" styleClass="list">

                        <apex:column headerValue="" width="3%">

                            <apex:actionStatus id="stsGetRatePlan">

                                <apex:facet name="stop">

                                    <apex:outputPanel id="panProductSelectComplete">

                                        <apex:image id="imgRadioBtnChk"
                                                    rendered="{!product.Id == selProductId}"
                                                    url="{!$Resource.zqu__radioBtnChk}" width="18" height="18" />

                                        <apex:image id="imgRadioBtnUnchk"
                                                    rendered="{!product.Id != selProductId}"
                                                    url="{!$Resource.zqu__radioBtnUnChk}" width="18" height="18" />

                                        <apex:actionSupport status="stsGetRatePlan"
                                                            event="onclick"
                                                            reRender="panProductSelector, panRatePlanSelector, panChargeGroup"
                                                            action="{!refreshRatePlans}">

                                            <apex:param assignTo="{!selProductId}" name="selProduct" value="{!product.Id}" />

                                        </apex:actionSupport>

                                    </apex:outputPanel>

                                </apex:facet>

                                <apex:facet name="start">

                                    <apex:image url="{!$Resource.zqu__ajaxLoading}" width="18" height="18" />

                                </apex:facet>

                            </apex:actionStatus>

                        </apex:column>

                        <apex:column headerValue="Name" value="{!product.Name}" width="40%" />
<!--
                        <apex:column headerValue="SKU" value="{!product.zqu__SKU__c}" width="15%" />
-->
                        <apex:column headerValue="Description" width="57%" value="{!product.zqu__Description__c}" />

                    </apex:pageBlockTable>

                    <!-- The section info and previous/next button -->
                    <table style="width: 100%; padding: 1em;">
                        <tr>
                            <td style="text-align: left;">
                                {!productSectionInfo}
                            </td>

                            <td style="text-align: right;">

                                <!-- Previous action -->
                                <apex:commandLink rendered="{!productHasPrevious}"
                                                    action="{!previousProductPage}"
                                                    reRender="panProductSelector, panRatePlanSelector, panChargeGroup">
                                    <apex:image value="{!$Resource.zqu__back_enabled}" />
                                </apex:commandLink>

                                <apex:image value="{!$Resource.zqu__back_disabled}" rendered="{!!productHasPrevious}"/>

                                <!-- Next action -->
                                <apex:commandLink rendered="{!productHasNext}"
                                                    action="{!nextProductPage}"
                                                    reRender="panProductSelector, panRatePlanSelector, panChargeGroup">

                                    <apex:image value="{!$Resource.zqu__forward_enabled}" />
                                </apex:commandLink>

                                <apex:image value="{!$Resource.zqu__forward_disabled}" rendered="{!!productHasNext}"/>

                            </td>
                        </tr>
                    </table>

                </apex:pageBlock>

            </apex:outputPanel>

            <apex:outputPanel id="panRatePlanSelector" rendered="{!displayProductCatalog}">

                <apex:pageBlock title="Product Details" rendered="{!showRatePlan}">
<!--  
                    <apex:pageBlockButtons style="text-align:right" location="top">

                        <apex:actionRegion >

                            <apex:inputText id="itRatePlanSearch" value="{!ratePlanSearchString}" />

                        </apex:actionRegion>

                        <apex:actionStatus id="stsRatePlanSearch">

                            <apex:facet name="start">

                                <apex:commandButton value="Searching..."
                                                    disabled="true"
                                                    status="stsRatePlanSearch" />

                            </apex:facet>

                            <apex:facet name="stop">

                                <apex:commandButton id="btnSearchRatePlans"
                                                    value="Search"
                                                    status="stsRatePlanSearch"
                                                    action="{!refreshRatePlans}"
                                                    rerender="panRatePlanSelector, panChargeGroup" />

                            </apex:facet>

                        </apex:actionStatus>

                    </apex:pageBlockButtons>
-->
 <!--keep in case we need filtering based on field
                    <apex:pageBlockSection rendered="{!ratePlanWrapperOptionsList.size > 0}">

                        <apex:repeat value="{!ratePlanWrapperOptionsList}" var="wrapOptions">

                            <apex:pageBlockSectionItem >

                                <apex:outputLabel value="{!wrapOptions.fieldLabel}" />

                                <apex:actionRegion >

                                    <apex:selectList value="{!wrapOptions.value}" size="1">

                                        <apex:actionSupport event="onchange"
                                                            rerender="msg, panProductSelector, panRatePlanSelector, panChargeGroup"
                                                            action="{!refreshRatePlans}" />

                                        <apex:selectOptions value="{!wrapOptions.items}" />

                                    </apex:selectList>

                                </apex:actionRegion>

                            </apex:pageBlockSectionItem>

                        </apex:repeat>

                    </apex:pageBlockSection>
-->

                    <apex:pageBlockTable value="{!ratePlanList}" var="ratePlan" id="tlbRatePlan" title="ratePlans"
                                            columns="3" cellpadding="3%" cellspacing="3%" styleClass="list">

                        <apex:column width="3%" headerValue="">

                            <apex:actionStatus id="stsGetQuoteCharge">

                                <apex:facet name="start">

                                    <apex:image url="{!$Resource.zqu__ajaxLoading}" width="18" height="18" />

                                </apex:facet>

                                <apex:facet name="stop">

                                    <apex:outputPanel id="ratePlanSelectComplete">

                                        <apex:image id="imgRadioBtnChk" rendered="{!ratePlan.Id == selRatePlanId}"
                                                    url="{!$Resource.zqu__radioBtnChk}" width="18" height="18" />

                                        <apex:image id="imgRadioBtnUnChk" rendered="{!ratePlan.Id != selRatePlanId}"
                                                    url="{!$Resource.zqu__radioBtnUnChk}" width="18" height="18" />

                                        <apex:actionSupport status="stsGetQuoteCharge"
                                                            event="onclick"
                                                            reRender="panRatePlanSelector, panChargeGroup, panChargeGroup"
                                                            action="{!refreshChargeGroup}">

                                            <apex:param assignTo="{!selRatePlanId}" name="selRatePlan" value="{!ratePlan.Id}" />

                                        </apex:actionSupport>

                                    </apex:outputPanel>

                                </apex:facet>

                            </apex:actionStatus>

                        </apex:column>

                        <apex:column headerValue="Name" value="{!ratePlan.Name}" width="30%" />

                        <apex:column headerValue="Description" value="{!ratePlan.zqu__Description__c}" width="67%" />

                    </apex:pageBlockTable>

                    <!-- The section info and previous/next button -->
                    <table style="width: 100%; padding: 1em;">
                        <tr>
                            <td style="text-align: left;">
                                {!ratePlanSectionInfo}
                            </td>

                            <td style="text-align: right;">

                                <!-- Previous action -->
                                <apex:commandLink rendered="{!ratePlanHasPrevious}"
                                                    action="{!previousRatePlanPage}"
                                                    reRender="panRatePlanSelector, panChargeGroup">
                                    <apex:image value="{!$Resource.zqu__back_enabled}" />
                                </apex:commandLink>

                                <apex:image value="{!$Resource.zqu__back_disabled}" rendered="{!!ratePlanHasPrevious}"/>

                                <!-- Next action -->
                                <apex:commandLink rendered="{!ratePlanHasNext}"
                                                    action="{!nextRatePlanPage}"
                                                    reRender="panRatePlanSelector, panChargeGroup">

                                    <apex:image value="{!$Resource.zqu__forward_enabled}" />
                                </apex:commandLink>

                                <apex:image value="{!$Resource.zqu__forward_disabled}" rendered="{!!ratePlanHasNext}"/>

                            </td>
                        </tr>
                    </table>

                </apex:pageBlock>

            </apex:outputPanel>


			<apex:pageMessages id="msg" />

            <apex:outputPanel id="panChargeGroup" rendered="{!displayProductCatalog}">

                <apex:pageBlock title="Charge" rendered="{!showChargeGroup}">

                    <apex:pageBlockTable styleClass="charges-table" value="{!chargeRows}" var="chargeRow">

                        <apex:column headerValue="Charge Name" value="{!chargeRow.charge.NAME}" width="20%" />

                        <apex:column headerValue="Type" value="{!chargeRow.charge.CHARGE_TYPE}" width="12%" />

                        <apex:column headerValue="Model" value="{!chargeRow.charge.MODEL}" width="12%" />

                        <apex:column headerValue="List Price" value="{!chargeRow.charge.LIST_PRICE}" width="7%" rendered="{!!isPercentProduct}"/>

                        <!-- Discount column, only display the '%' character if it's a number -->
                        <apex:column headerValue="Discount" width="7%" rendered="{!!isPercentProduct}">

                            <apex:inputText style="width:65%;font-weight:bold;"
                                            value="{!chargeRow.charge.DISCOUNT}"
                                            rendered="{!AND(chargeRow.charge.isDiscountEditable, !isPercentProduct)}">

                                <apex:actionSupport event="onchange"
                                                    action="{!discountChange}"
                                                    status="addingChargesStatus"
                                                    reRender="panChargeGroup" />

                            </apex:inputText>

                            <apex:outputText value="{!chargeRow.charge.DISCOUNT}"
                                                rendered="{!AND(!chargeRow.charge.isDiscountEditable, !isPercentProduct)}" />

                            <apex:outputText value=" %" rendered="{!AND(ISNUMBER(chargeRow.charge.DISCOUNT), !isPercentProduct)}" />

                        </apex:column>

                        <!--  Custom Discount -->
                        <apex:column headerValue="Discount" width="7%" rendered="{!isPercentProduct}">

                            <apex:inputText style="width:65%;font-weight:bold;" value="{!chargeRow.discount}" rendered="{!isPercentProduct}">
                                <apex:actionSupport event="onchange"
                                                    action="{!customDiscountChange}"
                                                    status="addingChargesStatus"
                                                    reRender="panChargeGroup" />
                            </apex:inputText>
                        </apex:column>

                        <!--  Custom List Price -->
                        <apex:column headerValue="List Price" width="7%" rendered="{!isPercentProduct}">

                            <apex:outputText style="width:65%;font-weight:bold;" value="{!chargeRow.listPrice}" rendered="{!isPercentProduct}"/>

                        </apex:column>

                        <!-- Effective price, only editable based on a boolean custom field? -->
                        <apex:column headerValue="Effective Price" width="7%">

                            <apex:inputText style="width:85%;font-weight:bold"
                                            value="{!chargeRow.charge.EFFECTIVE_PRICE}"
                                            rendered="{! AND(chargeRow.charge.isEffectivePriceEditable, !isPercentProduct)}">

                                <apex:actionSupport event="onchange"
                                                    action="{!effectiveChange}"
                                                    status="addingChargesStatus"
                                                    reRender="panChargeGroup" />

                            </apex:inputText>

                            <apex:outputText value="{!chargeRow.charge.EFFECTIVE_PRICE}"
                                            rendered="{! OR(!chargeRow.charge.isEffectivePriceEditable, isPercentProduct)}" />

                        </apex:column>

                        <!-- Quantity column, editable only if the charge is per unit, etc. -->
                        <apex:column headerValue="Quantity" width="7%">

                            <apex:inputText style="width:85%;font-weight:bold"
                                            value="{!chargeRow.charge.QUANTITY}"
                                            rendered="{!chargeRow.charge.isQuantityEditable}">

                                <apex:actionSupport event="onchange"
                                                    action="{!quantityChange}"
                                                    status="addingChargesStatus"
                                                    reRender="panChargeGroup" />

                            </apex:inputText>

                            <apex:outputText value="{!chargeRow.charge.QUANTITY}"
                                            rendered="{!!chargeRow.charge.isQuantityEditable}" />

                        </apex:column>

                        <apex:column headerValue="UOM" value="{!chargeRow.charge.UNIT_OF_MEASURE}" width="7%" />

                        <apex:column headerValue="Period" value="{!chargeRow.charge.PERIOD}" width="7%" />

                        <apex:column headerValue="List Total" value="{!chargeRow.charge.LIST_TOTAL}" width="7%" rendered="{!!isPercentProduct}"/>

                        <apex:column headerValue="Total" width="7%">

                            <apex:inputText style="width:85%;font-weight:bold;"
                                            value="{!chargeRow.charge.TOTAL}"
                                            rendered="{! AND(chargeRow.charge.isTotalEditable, !isPercentProduct)}">

                                <apex:actionSupport event="onchange"
                                                    action="{!totalChange}"
                                                    status="addingChargesStatus"
                                                    reRender="panChargeGroup" />

                            </apex:inputText>

                            <apex:outputText value="{!chargeRow.charge.TOTAL}"
                                                rendered="{! OR(!chargeRow.charge.isTotalEditable, isPercentProduct)}" />

                        </apex:column>

                    </apex:pageBlockTable>

                    <apex:pageBlockButtons location="bottom">

                        <apex:actionStatus id="addingChargesStatus" onStart="disableAllInput();" onStop="enableAllInput();">

                            <apex:facet name="stop">

                                <apex:outputPanel >

                                    <apex:commandButton value="Add"
                                                        action="{!addGroup}"
                                                        status="addingChargesStatus"
                                                        reRender="panChargeGroup, msg, hiddenBlock" />

                                    <apex:commandButton value="Cancel"
                                                        action="{!cancelDisplayProductCatalog}"
                                                        status="addingChargesStatus"
                                                        reRender="mainForm" />

                                </apex:outputPanel>

                            </apex:facet>

                            <apex:facet name="start">

                                <apex:outputPanel >

                                    <apex:image value="/img/loading32.gif" style="height: 12px" />

                                    <apex:commandButton value="Processing..."
                                                        status="addingChargesStatus"
                                                        disabled="true" />

                                </apex:outputPanel>

                            </apex:facet>

                        </apex:actionStatus>

                    </apex:pageBlockButtons>

                </apex:pageBlock>

            </apex:outputPanel>
            <!-- END insert product catalog -->



            <apex:pageBlockSection title="Changes vs. Original" columns="1" id="panChangesVsOriginal" rendered="false" >

                <apex:outputText value="No change yet." rendered="{!quoteAmendmentList.size == 0}" />

                <apex:pageBlockTable value="{!quoteAmendmentList}" var="amendment" rendered="{!quoteAmendmentList.size > 0}">

                    <apex:column value="{!amendment.zqu__Description__c}" />


                    <apex:column headerValue="Total Change" width="10%">

                        <apex:outputText value="+{!amendment.zqu__TotalAmount__c}"
                                            rendered="{!amendment.zqu__TotalAmount__c != null && amendment.zqu__TotalAmount__c >= 0}"
                                            style="font-weight:bold;color:green;" />

                        <apex:outputText value="{!amendment.zqu__TotalAmount__c}"
                                            rendered="{!amendment.zqu__TotalAmount__c != null && amendment.zqu__TotalAmount__c < 0}"
                                            style="font-weight:bold;color:red;" />

                    </apex:column>


                    <apex:column headerValue="Actions" width="10%">

                        <apex:commandButton action="{!undoAmendment}"
                                            value="Undo"
                                            reRender="hiddenBlock, mainForm, msg"
                                            status="stsProcessAmendment">

                            <apex:param name="amendmentId"
                                        value="{!amendment.Id}"
                                        assignTo="{!quoteAmendmentToUndo}" />

                        </apex:commandButton>

                    </apex:column>

                </apex:pageBlockTable>

            </apex:pageBlockSection>

            <apex:pageBlockButtons location="bottom">

                <apex:actionStatus id="stsProcessAmendment" onStart="disableAllInput();" onStop="enableAllInput();">

                    <apex:facet name="start">

                        <apex:outputPanel >

                            <apex:image value="/img/loading32.gif" style="height:15px;" />

                            <apex:commandButton value="Processing..."
                                                disabled="true"
                                                reRender="mainForm, msg"
                                                status="stsProcessAmendment" />

                        </apex:outputPanel>

                    </apex:facet>

                    <apex:facet name="stop">

                        <apex:outputPanel >

                            <apex:commandButton action="{!returnToQuote}"
                                                status="stsProcessAmendment"
                                                reRender="mainForm, msg"
                                                value="Return to Quote" />

                        </apex:outputPanel>

                    </apex:facet>

                </apex:actionStatus>

            </apex:pageBlockButtons>

        </apex:pageBlock>

        <!-- This is just a fix to pass an attribute with a command button as explained here:
        http://blog.jeffdouglas.com/2010/03/04/passing-parameters-with-a-commandbutton/ -->
        <apex:pageBlock id="hiddenBlock" rendered="false"></apex:pageBlock>

    </apex:form>

</apex:page>